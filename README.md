# R2-Gallery

个人独立相册，其中图片储存采用 Cloudflare R2 实现。


## 大架构

- 使用本软件可创建一个或多个图库 (Gallery)
- 每个图库可包含一个或多个相册 (Album)
- 每个相册可包含一张或多张图片 (Picture)
- 每个图库/相册/图片都有对应的 toml 文件, 包含了它们的信息 (例如标题/简介)
- 使用 `r2g render` 命令会根据上述 toml 文件生成网页

### 三种输出

使用 `r2g render` 命令生成网页时, 有 3 种不同的输出:

- **本地预览**: 图片地址是本地文件, 方便预览效果, 减少云端流量消费.
- **正常网站**: 图片地址是云端文件, 通常就是将这个输出结果发布到网上.
- **Cloudflare R2**: 直接将网页上传到云端, 通过在 R2 设置的网址即可访问相册.

## Picture

- 文件名只能使用 0-9, a-z, A-Z, _(下划线), -(短横线), .(点)
- 文件名包括后缀名, 不包括目录
- 文件名请尽量不要太长
- toml 里的文件名不可手动更改
- 自动获取简单描述的第一行作为图片的标题
- 简单描述采用纯文本格式, 有字数限制, 建议不要写太长
- 如果有较长的描述, 可以写在 story 里, 采用 Markdown 格式
- checksum, 用来判断 notes/story 有无变更

## Album

- 使用命令 `r2g album -new NAME` 新建相册
- 每个相册一个文件夹
- 上述命令里的 NAME 是相册的文件夹名称  
  - 只能使用 0-9, a-z, A-Z, _(下划线), -(短横线), .(点)  
  - 并且应尽量短
- 在相册文件夹内有一个 album.toml 文件, 一个 metadata 文件夹
- 可在 album.toml 文件里填写相册标题, 相册标题可以使用任何字符
- 相册简介采用纯文本格式, 第一行是相册标题
- 如果有较长的描述, 可以写在 story 里, 采用 Markdown 格式
- ctime, 相册创建时间
- utime, 相册更新时间 (比如添加图片, 就会更新该时间)
- r2_html, 相册网页的 R2 地址 (自动获取)
- checksum, 用来判断 notes/story 有无变更
- sort_by(排序方法): 按创建时间/按更新时间/由列表指定等共 5 种排序方式
- 采用 SortBy.List 以外的方式时, Pictures 列表可以为空
- 采用 SortBy.List 方式时, 必须填写 Pictures 列表
- 采用 SortBy.List 方式时, 只显示列表中的图片, 未列出的就不会显示
  (但图片本身仍可被公开访问, 只是不出现在相册中)
- 采用 SortBy.List 以外的方式时, 使用命令
  `r2g album --rewrite-sortby-list -name NAME`
  可以自动填充 Pictures 列表 (目的是方便后续改为 SortBy.List 方式)
- Pictures (图片文件名列表), 只在采用 SortBy.List 方式时才生效
- 采用 SortBy.List 方式时, 如果添加图片, 则自动添加到列表头部
- cover, 指定一个图片文件名作为相册封面, 留空则采用第一张

## Gallery

- author, 图库作者 (必填)
- notes, 图库简介 (纯文本格式, 第一行是图库标题)
- 如果有较长的描述, 可以写在 story 里, 采用 Markdown 格式
- checksum, 用来判断 notes/story 有无变更
- 相册列表
  - 相册依次排序
  - 不在列表中的相册不会显示在图库网页中 (但相册本身仍可被公开访问)
- 首页可选择 3 种展示方式
  - 相册列表(封面)
  - 最新单图
  - 相册介绍(notes+story+相册列表)

## Output (输出)

有三种输出:

- Cloudflare R2 (直接输出到云端)
- 静态网站      (图片地址采用 R2 地址)
- 静态网站      (图片地址采用本地地址/相对地址)

每一次渲染都会输出两种静态网站, 另外有一个专门的命令输出到云端.

## 创建一个新图库

安装了 r2g 命令后, 进入任何一个空文件夹内, 执行命令 `rg2 -init`
初始化一个图库.

初始化成功后，在当前文件夹 (以下称为 "图库根目录") 内可以看到：

- **templates** (相册网页模板)
- **output_local** (本地网站, 图片地址采用相对路径)
- **output_web** (正常网站, 图片地址是 R2 公开仓库的网址)
- **gallery.toml** (图库作者, 图库简介等)

请用文本编辑器打开 gallery.toml 填写图库作者, 图库简介等.

执行命令 `r2g -info` 查看图库信息.

## 创建相册

- 使用命令 `r2g album -new NAME` 新建相册
- 其中 NAME 是相册文件夹名称
  - 只能使用 0-9, a-z, A-Z, _(下划线), -(短横线), .(点)  
  - 相册名称会成为网址的一部分, 因此建议尽量短一点

### 填写相册信息

使用上述命令创建相册后, 会得到一个新文件夹,
进入该文件夹内, 可以看到一个 album.toml 文件.

- 请在 album.toml 文件里填写相册简介 (默认为相册文件夹名)
- 相册简介采用纯文本格式, 第一行是相册标题
- 如果有较长的描述, 可以写在 story 里, 采用 Markdown 格式

### 相册排序

- 新增的相册会被自动添加到 gallery.toml 文件的 albums 列表中
- 如果想调整相册顺序, 可直接编辑 gallery.toml 文件中的 albums 列表
- 你也可以删除列表中的相册文件夹名, 不在列表中的相册不会显示在图库网页中
  (但相册本身仍可被公开访问)

## 添加图片

- 直接复制/剪切图片, 粘贴到相册文件夹中.
- 如果在终端使用 cp 或 mv 命令, 要注意防止覆盖同名文件.
  - 在 Linux 里, 使用 `-i` 开关, 例如 `mv -i src.jpg dest.jpg`
  - 在 Windows 里, 使用 `-cf` 开关, 例如 `mv -cf src.jpg dest.jpg`

### 填写图片信息

添加一张或多张图片到相册文件夹之后, 在图库根目录执行命令
`r2g album -update NAME` (其中 NAME 是相册文件夹名)
会自动给新增的图片生成同名 toml 文件.

- 请在 toml 文件里填写图片简介 (默认为图片文件名)
- 相册简介采用纯文本格式, 第一行是相册标题
- 如果有较长的描述, 可以写在 story 里, 采用 Markdown 格式

填写信息后, 执行命令 `r2g render NAME` (其中 NAME 是相册文件夹名)
或 `r2g render -all` 更新网页.

### 图片排列顺序

有 3 种排序方法: 按创建时间 / 按创建时间倒序 / 由列表指定

- 采用 SortBy.List 以外的方式时, album.toml 中的 pictures 列表可以为空
- 采用 SortBy.List 方式时, 必须填写 album.toml 中的 pictures 列表
- 采用 SortBy.List 方式时, 只显示列表中的图片, 未列出的就不会显示
  (但图片本身仍可被公开访问, 只是不出现在相册中)


## 建议使用终端文本编辑器

本软件的大部分操作都需要在终端输入命令, 有时需要稍稍修改一下 toml,
这种情况下如果切换到文本编辑器去操作, 会感觉优点麻烦, 因此建议使用类似
Vim/Emacs 的终端文本编辑器, 就很方便.

我找到了 [micro](https://github.com/zyedidia/micro), 它类似 Vim/Emacs
并且更轻, 也更易学易用, 优点:

- 启动速度飞快, 感觉非常轻巧.
- 非常易学易用, 支持鼠标选择, 以及用 Ctrl-C / Ctrl-V 来复制黏贴.  
  支持 Ctrl-S 保存 / Ctrl-A 全选等符合现代习惯的快捷键.

